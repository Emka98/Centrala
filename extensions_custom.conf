[from-internal-custom]

exten => *777,1,Answer()
exten => *777,n,NoOp(Rozpoczynam sesje nagrywania dla Callback)
exten => *777,n,Set(MOJ_NUMER=${CALLERID(num)})
exten => *777,n,Wait(1)

; 1. Nagrywanie wiadomości
exten => *777,n,Playback(vm-intro) ; Komunikat: "Nagraj po sygnale"
exten => *777,n,Record(/tmp/callback_msg_${MOJ_NUMER}:wav,3,30)
exten => *777,n,Playback(auth-thankyou) ; Komunikat: "Dziękujemy"

; 2. Generowanie pliku call (oddzwonienie)
; Tworzymy plik w /tmp, a potem przenosimy do spoolera
exten => *777,n,System(echo "Channel: Local/${MOJ_NUMER}@from-internal" > /tmp/cb_${MOJ_NUMER}.call)
exten => *777,n,System(echo "MaxRetries: 1" >> /tmp/cb_${MOJ_NUMER}.call)
exten => *777,n,System(echo "RetryTime: 5" >> /tmp/cb_${MOJ_NUMER}.call)
exten => *777,n,System(echo "WaitTime: 40" >> /tmp/cb_${MOJ_NUMER}.call)
exten => *777,n,System(echo "Context: callback-playback" >> /tmp/cb_${MOJ_NUMER}.call)
exten => *777,n,System(echo "Extension: s" >> /tmp/cb_${MOJ_NUMER}.call)
exten => *777,n,System(echo "Priority: 1" >> /tmp/cb_${MOJ_NUMER}.call)
exten => *777,n,System(echo "Set: MSG_FILE=/tmp/callback_msg_${MOJ_NUMER}" >> /tmp/cb_${MOJ_NUMER}.call)

; 3. Odczekaj chwilę, żebyś zdążył się rozłączyć przed oddzwonieniem
exten => *777,n,System(sleep 5 && mv /tmp/cb_${MOJ_NUMER}.call /var/spool/asterisk/outgoing/)
exten => *777,n,Hangup()

; --- KONTEKST ODTWARZANIA (Gdy system do Ciebie oddzwoni) ---
[callback-playback]
exten => s,1,Answer()
exten => s,n,Wait(1)
exten => s,n,NoOp(Odtwarzam nagrana wiadomosc: ${MSG_FILE})
exten => s,n,Playback(${MSG_FILE})
exten => s,n,Wait(1)
exten => s,n,System(rm -f ${MSG_FILE}.wav) ; Usuwa nagranie po odsłuchaniu
exten => s,n,Hangup()
